import{O as e,p as t,u as n}from"./chunks/runtime-core.esm-bundler.Ce81gwEo.js";import{t as r}from"./chunks/plugin-vue_export-helper.CN9xd60_.js";const i=JSON.parse(`{"title":"Profiling","description":"","frontmatter":{"title":"Profiling","outline":"deep","head":[["meta",{"property":"og:title","content":"Profiling"}],["meta",{"name":"twitter:title","content":"Profiling"}],["meta",{"property":"og:description","content":"A collection of high-performance JavaScript tools written in Rust"}],["meta",{"name":"twitter:description","content":"A collection of high-performance JavaScript tools written in Rust"}],["meta",{"property":"og:url","content":"https://oxc.rs/docs/contribute/profiling.html"}]]},"headers":[],"relativePath":"docs/contribute/profiling.md","filePath":"docs/contribute/profiling.md"}`);var a={name:`docs/contribute/profiling.md`};function o(r,i,a,o,s,c){return e(),n(`div`,null,[...i[0]||=[t(`<h1 id="profiling" tabindex="-1">Profiling <a class="header-anchor" href="#profiling" aria-label="Permalink to “Profiling”">​</a></h1><h2 id="compiling-oxlint-in-release-mode-with-debug-information" tabindex="-1">Compiling <code>oxlint</code> in release mode with debug information <a class="header-anchor" href="#compiling-oxlint-in-release-mode-with-debug-information" aria-label="Permalink to “Compiling oxlint in release mode with debug information”">​</a></h2><p>For profiling, you will need to compile the <code>oxlint</code> binary in release mode with debug information enabled. You can do that by passing <code>--profile release-with-debug</code> to <code>cargo build</code>:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --profile</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> release-with-debug</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --bin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> oxlint</span></span></code></pre></div><p>After building, the binary is located at <code>./target/release-with-debug/oxlint</code>. This is the binary that should be used for profiling.</p><h2 id="cpu-samply" tabindex="-1">CPU - Samply <a class="header-anchor" href="#cpu-samply" aria-label="Permalink to “CPU - Samply”">​</a></h2><p><a href="https://github.com/mstange/samply" target="_blank" rel="noreferrer">Samply</a> is a command line CPU profiler which uses the Firefox profiler as its UI. Works on macOS and Linux.</p><p>To use Samply with <code>oxlint</code>, run <code>samply record</code> followed by the <code>oxlint</code> command and arguments:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">samply</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./target/release-with-debug/oxlint</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><p>To improve the profiling experience, you might consider some of the following options:</p><ul><li><code>oxlint</code>: <code>--silent</code> will suppress diagnostics output and keep the profile more focused.</li><li><code>oxlint</code>: <code>--threads 1</code> will run the linter single threaded, which is slower, but makes it easier to analyze the profile for single-threaded performance.</li><li><code>samply record</code>: <code>--rate &lt;number&gt;</code> will sample the profile at a higher rate. The default is 1000Hz (1ms), but increasing this will provide more detailed information at the cost of a larger profile file.</li></ul><p>For example, running <code>oxlint</code> single-threaded with a 0.1ms sample rate:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">samply</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --rate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./target/release-with-debug/oxlint</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --silent</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --threads</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><h2 id="cpu-mac-xcode-instruments" tabindex="-1">CPU - Mac Xcode Instruments <a class="header-anchor" href="#cpu-mac-xcode-instruments" aria-label="Permalink to “CPU - Mac Xcode Instruments”">​</a></h2><p><a href="https://github.com/cmyr/cargo-instruments" target="_blank" rel="noreferrer"><code>cargo instruments</code></a> is the tool of choice to bridge Mac Xcode instruments.</p><p>The following instruction replicates the procedure of <code>cargo instruments</code>.</p><p>First, install Xcode Instruments command-line tools:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">xcode-select</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --install</span></span></code></pre></div><p>Then, if you haven&#39;t already, <a href="#compiling-oxlint-in-release-mode-with-debug-information">ensure that the <code>oxlint</code> binary is compiled</a>.</p><p>Under the hood, <code>cargo instruments</code> invokes the <code>xcrun xctrace</code> command, which is equivalent to</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">xcrun</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xctrace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> record</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --template</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Time Profile&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --output</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --launch</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/oxc/target/release-with-debug/oxlint</span></span></code></pre></div><p>Running the command above produces the following output</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>Starting recording with the Time Profiler template. Launching process: oxlint.</span></span>
<span class="line"><span>Ctrl-C to stop the recording</span></span>
<span class="line"><span>Target app exited, ending recording...</span></span>
<span class="line"><span>Recording completed. Saving output file...</span></span>
<span class="line"><span>Output file saved as: Launch_oxlint_2023-09-03_4.41.45 PM_EB179B85.trace</span></span></code></pre></div><p>Open the trace file <code>open Launch_oxlint_2023-09-03_4.41.45\\ PM_EB179B85.trace</code>.</p><p>To see a top down trace:</p><ol><li>On the top panel, click CPUs</li><li>On the left input box, click <code>x</code> then select <code>Time Profiler</code></li><li>At the bottom panel, click &quot;Call Tree&quot;, turn on &quot;Invert Call Tree&quot; and turn off separate by thread.</li></ol><p>For memory and disk operations, use <code>--template &#39;Allocations&#39;</code> and <code>--template &#39;File Activity&#39;</code>.</p><p>For more detailed CPU profiling, such as L1/L2 cache misses, cycle and instruction counts, and branch prediction info, you need to use a custom &quot;CPU Counters&quot; template:</p><ol><li>Open Instruments and select the &quot;CPU Counters&quot; template.</li><li>In the &quot;CPU Counters&quot; settings: <ol><li>Turn on the &quot;High Frequency Sampling&quot; option.</li><li>Below the &quot;High Frequency Sampling&quot; option, click the plus icon and select an event type. Some suggested event types: <ul><li>Cycles - for getting a rough idea of how many CPU cycles are spent in each function.</li><li>Instructions - for getting a rough idea of how many CPU instructions are executed in each function and how many cycles that takes</li><li><code>L1D_CACHE_MISS_LD</code> - count of L1 cache misses from loading data from memory</li></ul></li></ol></li><li>Once you have enabled the events you are interested in, save the template in &quot;File &gt; Save as Template ...&quot; and give it a name.</li><li>Now you can use this with <code>xctrace</code> by passing the template name to the <code>--template</code> option: <code>xcrun xctrace record --template &#39;My Custom CPU Counters&#39; --output . --launch -- /path/to/oxc/target/release-with-debug/oxlint</code></li></ol><h2 id="heap-allocation-dhat" tabindex="-1">Heap Allocation - dhat <a class="header-anchor" href="#heap-allocation-dhat" aria-label="Permalink to “Heap Allocation - dhat”">​</a></h2><p><a href="https://docs.rs/dhat/latest/dhat" target="_blank" rel="noreferrer">dhat</a> is a heap profiler that can help identify memory leaks and analyze heap allocation patterns.</p><h3 id="setup" tabindex="-1">Setup <a class="header-anchor" href="#setup" aria-label="Permalink to “Setup”">​</a></h3><p>Add dhat as a dependency to your <code>Cargo.toml</code>:</p><div class="language-toml"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dependencies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dhat = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0.3&quot;</span></span></code></pre></div><p>Then add a global allocator at the top of your binary crate:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[global_allocator]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ALLOC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dhat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Alloc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dhat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Alloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><h3 id="profiling-1" tabindex="-1">Profiling <a class="header-anchor" href="#profiling-1" aria-label="Permalink to “Profiling”">​</a></h3><p>Create a profiler in the scope you want to profile. The profiler will track allocations from when it&#39;s created until it&#39;s dropped:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _profiler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dhat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Profiler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">new_heap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Your code here - all heap allocations will be tracked</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>You can also add <code>_profiler</code> to any function to track memory only for that specific function:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> my_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _profiler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> dhat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Profiler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">new_heap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Only allocations within this function scope will be tracked</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>The profiler will automatically generate a <code>dhat-heap.json</code> file when it&#39;s dropped.</p><h3 id="loading-and-reading-the-profile" tabindex="-1">Loading and Reading the Profile <a class="header-anchor" href="#loading-and-reading-the-profile" aria-label="Permalink to “Loading and Reading the Profile”">​</a></h3><p>After running your program, a <code>dhat-heap.json</code> file will be created in your working directory.</p><p>To analyze the profile:</p><ol><li>Open the dhat viewer at <a href="https://nnethercote.github.io/dh_view/dh_view.html" target="_blank" rel="noreferrer">https://nnethercote.github.io/dh_view/dh_view.html</a></li><li>Load the <code>dhat-heap.json</code> file</li><li>Select a metric in &quot;Sort metrics&quot; to analyze different aspects of memory usage: <ul><li><strong>&quot;At t-gmax (bytes)&quot;</strong>: Shows allocations at the point of peak memory usage. Use this to identify what&#39;s consuming the most memory when your program reaches its maximum heap size.</li><li><strong>&quot;At t-end (bytes)&quot;</strong>: Shows memory that was not dropped before the profiler was destroyed. This is particularly useful for identifying memory leaks, as it reveals allocations that remain at the end of the profiled scope.</li><li><strong>&quot;Total (bytes)&quot;</strong>: Shows the total number of bytes allocated over the entire execution. Use this to identify which parts of your code are performing the most allocations, even if the memory is later freed.</li></ul></li></ol><h3 id="advanced-controlling-profiler-lifetime" tabindex="-1">Advanced: Controlling Profiler Lifetime <a class="header-anchor" href="#advanced-controlling-profiler-lifetime" aria-label="Permalink to “Advanced: Controlling Profiler Lifetime”">​</a></h3><p>For more control over when profiling stops, you can explicitly manage the profiler&#39;s lifetime. For example, to profile only the core logic and exclude cleanup:</p><div class="language-rust"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyApp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    profiler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Option</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;dhat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Profiler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // other fields</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">impl</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyApp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;mut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Drop the profiler here to capture the heap state before cleanup</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        self</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">profiler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // cleanup code</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This pattern helps identify which data structures are holding memory at a specific point in your program&#39;s execution.</p>`,50)]])}var s=r(a,[[`render`,o]]);export{i as __pageData,s as default};